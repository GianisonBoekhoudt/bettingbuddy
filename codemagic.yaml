workflows:
  android-build:
    name: Android Build
    instance_type: mac_mini_m1
    max_build_duration: 60
    environment:
      vars:
        PACKAGE_NAME: "org.bettingbuddy.app"
        PYTHONUNBUFFERED: "1"
        P4A_IGNORE_DEPENDENCIES: "1"
    scripts:
      - name: Setup Python 3.10
        script: |
          brew install pyenv
          pyenv install 3.10.13
          pyenv global 3.10.13
          python3 --version
          echo "Using Python $(python3 --version)"
          
      - name: Install dependencies
        script: |
          pip3 install --upgrade pip
          pip3 install setuptools wheel
          pip3 install Cython==0.29.33
          pip3 install buildozer==1.5.0
          pip3 install pillow==9.5.0 cairosvg
          pip3 install kivy==2.1.0 kivymd==1.1.1
          brew install pkg-config sdl2 sdl2_image sdl2_ttf sdl2_mixer
          brew install automake libtool
          
      - name: Install Buildozer with Python 3.10
        script: |
          python3 -m pip install git+https://github.com/kivy/python-for-android.git@develop
          
      - name: Clean previous build
        script: |
          rm -rf .buildozer || true
          rm -rf bin || true
          mkdir -p bin
          
      - name: Use Codemagic's preinstalled Android SDK/NDK
        script: |
          echo "Available Android SDK/NDK on Codemagic:"
          ls -la "$ANDROID_SDK_ROOT" || echo "Android SDK not found at ANDROID_SDK_ROOT"
          ls -la "$ANDROID_NDK_HOME" || echo "Android NDK not found at ANDROID_NDK_HOME"
          
          # Use CodeMagic's NDK and SDK paths in buildozer.spec
          sed -i '' 's/^android.sdk_path =.*/android.sdk_path = $ANDROID_SDK_ROOT/' buildozer.spec || echo "android.sdk_path = $ANDROID_SDK_ROOT" >> buildozer.spec
          sed -i '' 's/^android.ndk_path =.*/android.ndk_path = $ANDROID_NDK_HOME/' buildozer.spec || echo "android.ndk_path = $ANDROID_NDK_HOME" >> buildozer.spec
          
          # Prevent buildozer from downloading NDK
          sed -i '' 's/^android.ndk =.*/android.ndk = 25.1.8937393/' buildozer.spec
          sed -i '' 's/^android.accept_sdk_license =.*/android.accept_sdk_license = True/' buildozer.spec || echo "android.accept_sdk_license = True" >> buildozer.spec
          sed -i '' 's/^android.skip_update =.*/android.skip_update = True/' buildozer.spec || echo "android.skip_update = True" >> buildozer.spec
          
      - name: Update buildozer.spec
        script: |
          echo "Updating buildozer.spec configuration..."
          # Update log level
          sed -i '' 's/log_level = 1/log_level = 2/g' buildozer.spec || echo "Could not find log_level setting"
          grep -q "log_level" buildozer.spec || echo "log_level = 2" >> buildozer.spec
          
          # Update architecture and Android settings
          sed -i '' 's/^android.arch =.*/android.arch = arm64-v8a/' buildozer.spec
          sed -i '' 's/^p4a.branch =.*/p4a.branch = develop/' buildozer.spec || echo "p4a.branch = develop" >> buildozer.spec
          sed -i '' 's/^android.api =.*/android.api = 33/' buildozer.spec
          sed -i '' 's/^android.sdk =.*/android.sdk = 33/' buildozer.spec
          sed -i '' 's/^requirements =.*/requirements = python3,kivy==2.1.0,kivymd==1.1.1,requests,pillow==9.5.0,plyer,sqlite3,datetime,cairosvg/' buildozer.spec
          
          echo "Buildozer.spec after updates:"
          cat buildozer.spec
          
      - name: Set up files and directories for buildozer
        script: |
          # Create necessary directories to avoid downloads
          mkdir -p $HOME/.buildozer/android/platform
          
          # Force use of existing SDK/NDK
          echo "Creating buildozer.buildozer file to skip SDK/NDK download"
          mkdir -p $HOME/.buildozer
          cat > $HOME/.buildozer/.buildozer_settings.json << EOF
          {"android_sdk": "$ANDROID_SDK_ROOT", "android_ndk": "$ANDROID_NDK_HOME"}
          EOF
          
          # Display settings
          cat $HOME/.buildozer/.buildozer_settings.json
          
      - name: Build Android APK
        script: |
          # Generate debug keystore
          echo "Generating debug keystore"
          keytool -genkeypair -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          mkdir -p ~/.android
          cp debug.keystore ~/.android/debug.keystore
          
          # Set environment variables
          export P4A_IGNORE_DEPENDENCIES=1
          export PYTHONPATH=$PYTHONPATH:$PWD
          export ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT
          export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          
          # Show installed packages
          echo "Installed pip packages:"
          pip3 list
          
          # Run buildozer with more verbose output
          echo "Starting buildozer build with Python 3.10..."
          python3 -m buildozer android debug -v
          
      - name: Find and Copy APKs
        script: |
          echo "Searching for APK files..."
          find . -name "*.apk" -type f | tee apk_list.txt
          
          # Copy APKs to expected locations
          mkdir -p bin/
          find . -name "*.apk" -type f -exec cp {} bin/ \; || echo "No APKs found"
          
          # Create fake APK if none found (for debugging)
          if [ ! -f bin/*.apk ]; then
            echo "No APKs found, creating a placeholder for debugging"
            echo "This is a placeholder file to indicate build issues" > bin/build-failed-no-apk.txt
          fi
          
          # List what we found
          echo "Contents of bin directory:"
          ls -la bin/
          
    artifacts:
      - bin/*
      - apk_list.txt
      - buildozer.spec
    publishing:
      email:
        recipients:
          - gianison.boekhoudt@icloud.com
